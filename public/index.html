<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat with Firebase and Vue.js</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
    <script>
      var config = {
        apiKey: "AIzaSyAhQji5X5vCoKebrXw6jX7EE_CBGJo3VlM",
        authDomain: "test-todo-31ea2.firebaseapp.com",
        databaseURL: "https://test-todo-31ea2.firebaseio.com",
        projectId: "test-todo-31ea2",
        storageBucket: "test-todo-31ea2.appspot.com",
        messagingSenderId: "410075204641"
      };
      firebase.initializeApp(config);
    </script>
  </head>
  <body>
    <div id="message">
      <h1>chat!</h1>
      <ul id="chatlog">
        <li v-for="chat in chats">{{chat.user}}: {{chat.text}}</li>
      </ul>
      <div>
        <input
          type="text"
          v-if="authenticated"
          v-on:keydown.enter="say"
          v-bind:disabled="sending"
          v-model="message">
        <button
          v-if="authenticated"
          v-bind:disabled="sending"
          v-on:click="say">{{sending ? 'sending...' : 'say'}}</button>
        <button v-if="!authenticated" v-on:click="login">GitHub で login して発言</button>
      </div>
    </div>

    <script>
      var db = firebase.database();
      var chats = db.ref("/chats");

      var app = new Vue({
        el: '#message',

        data: {
          chats: [],
          message: '',
          authenticated: false,
          user: null,
          sending: false
        },

        methods: {
          say: async function(){
            try {
              this.sending = true;
              await chats.push({text: this.message, user: this.user});
            } catch (e) {
              alert(e);
            }

            this.message = '';
            this.sending = false;
          },
          login: async function() {
            var provider = new firebase.auth.GithubAuthProvider();
            provider.addScope('user');
            try {
              await firebase.auth().signInWithPopup(provider);
            } catch (e) {
              alert('なんかだめ');
              console.error(error);
            }
          }
        }
      });

      chats.on("value", function(snapshot) {
        app.chats = snapshot.val()
      });

      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          app.user = user.displayName;
          app.authenticated = true;
        } else {
          app.authenticated = false;
        }
      });
    </script>
  </body>
</html>
